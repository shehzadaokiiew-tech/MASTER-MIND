<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğ—§ğ—›ğ—˜ ğ—•ğ—˜ğ—¥ğ—Ÿğ—œğ—¡ ğ— ğ—”ğ—¦ğ—§ğ—˜ğ—¥ ğ—¦ğ—˜ğ—¥ğ—©ğ—˜ğ—¥ ğŸ‘¿</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* VIP styling - neat, no spelling mistakes */
    :root{
      --bg-dark:#080808;
      --accent-1:#00d1ff;
      --accent-2:#ff5c7c;
      --vip:#a17cf3;
      --muted:#bfc8c2;
    }
    html,body{height:100%; margin:0; padding:0; font-family:'Poppins',sans-serif; background:var(--bg-dark); color:#fff}
    .page {
      display:flex;
      justify-content:center;
      padding:22px;
      box-sizing:border-box;
    }

    .card-left{
      width:420px;
      border-radius:14px;
      padding:20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
      color:#CAFF0D;
    }
    .vip-title{
      font-family:'Montserrat',sans-serif;
      font-weight:800;
      font-size:1.25rem;
      letter-spacing:1px;
      color: white;
      margin-bottom:8px;
    }
    .form-control{
      background:transparent;
      border:1px double rgba(20,89,190,0.18);
      color:#0CC618;
      height:44px;
      border-radius:10px;
      padding:8px 10px;
      margin-bottom:12px;
      font-weight:600;
    }
    select.form-control{height:44px}
    label.small-muted{ color:var(--muted); font-size:0.86rem; display:block; margin-bottom:6px; font-weight:700; }
    .btn-submit{
      width:100%;
      border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    /* Console area */
    .console-card{
      margin-left:22px;
      flex:1;
      min-width:520px;
      max-width:920px;
      border-radius:12px;
      padding:14px;
      background: linear-gradient(180deg, rgba(2,6,23,0.55), rgba(4,10,30,0.65));
      border:1px solid rgba(20,255,180,0.04);
      box-shadow: 0 20px 60px rgba(2,8,23,0.7);
      display:flex;
      flex-direction:column;
      color:#bfffc8;
    }

    .console-header{ display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap;}
    .status-pill{ padding:8px 14px; border-radius:999px; font-weight:800; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#E7FFF0; }
    .meta-small{ color:var(--muted); font-weight:700; font-size:0.9rem; }

    .console-output{
      background: linear-gradient(180deg, rgba(0,0,0,0.6), rgba(8,8,8,0.4));
      border-radius:10px;
      padding:12px;
      flex:1;
      overflow:auto;
      font-family: 'JetBrains Mono', monospace;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: inset 0 0 40px rgba(0,0,0,0.2);
    }

    .console-row { display:flex; gap:8px; align-items:center; margin-top:10px; }
    .btn-small { padding:6px 10px; border-radius:10px; font-weight:700; }

    /* Glowing neon header */
    .neon {
      display:inline-block;
      font-weight:900;
      background: linear-gradient(90deg,#ffd166,#ff5c7c,#a17cf3);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      font-size:20px;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    /* responsive */
    @media (max-width:1100px){
      .page{padding:12px}
      .console-card{margin-left:0; margin-top:18px; min-width:unset; width:100%}
      .card-left{width:100%; max-width:640px}
    }

    /* small helper */
    .cookie-preview{ background:rgba(255,255,255,0.02); padding:6px 10px; border-radius:8px; color:#eafee8; font-weight:700; }
    .log-line{ padding:6px 0; border-bottom:1px dashed rgba(255,255,255,0.02); }
  </style>
</head>
<body>
  <div class="page">
    <div class="card-left">
      <div class="vip-title"><span class="neon">BERLIN TOLEX CONTROLLER</span></div>

      <!-- Cookie option -->
      <div style="margin-top:6px">
        <label class="small-muted">COOKIE OPTION</label>
        <select id="cookieOption" class="form-control" onchange="toggleCookieMode()">
          <option value="manual">Cookie Text (paste)</option>
          <option value="file">Cookie File (upload .txt)</option>
        </select>
      </div>

      <div id="manualCookie" style="margin-top:8px;">
        <label class="small-muted">Paste Cookie</label>
        <input id="cookieText" class="form-control" placeholder="cookie_here...">
      </div>

      <div id="fileCookie" style="display:none; margin-top:8px;">
        <label class="small-muted">Upload Cookie File (.txt)</label>
        <input type="file" id="cookieFile" class="form-control" accept=".txt">
      </div>

      <!-- Required fields: First + Second + Msg file -->
      <div style="margin-top:10px;">
        <label class="small-muted">1st Name</label>
        <input id="firstName" class="form-control" placeholder="First name" required>
      </div>

      <div style="margin-top:6px;">
        <label class="small-muted">2nd Hero Name</label>
        <input id="secondName" class="form-control" placeholder="Hero name" required>
      </div>

      <div style="margin-top:8px;">
        <label class="small-muted">Message File (txt)</label>
        <input type="file" id="msgFile" class="form-control" accept=".txt" required>
      </div>

      <div style="margin-top:8px;">
        <label class="small-muted">Time per (seconds)</label>
        <input type="number" id="timePer" class="form-control" value="2" min="1" required>
      </div>

      <button id="startBtn" class="btn btn-primary btn-submit" style="margin-top:10px"> START</button>

      <div style="margin-top:12px" class="small-muted">
        Cookie preview: <span id="cookiePreview" class="cookie-preview">-</span>
      </div>

      <hr style="border-color: rgba(255,255,255,0.03); margin-top:12px;">

      <div style="margin-top:6px;">
        <label class="small-muted">Stop Task (Task ID)</label>
        <input id="stopTaskId" class="form-control" placeholder="Enter Task ID to stop">
      </div>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="stopBtn" class="btn btn-danger btn-submit" style="flex:1">Stop</button>
        <button id="stopLastBtn" class="btn btn-warning btn-submit" style="flex:1">Stop Last</button>
      </div>

      <div style="margin-top:10px" class="small-muted">
        Note: Cookie saved in browser cookie <code>vip_token</code>. Page refresh will attempt to resume last task.
      </div>
    </div>

    <div class="console-card">
      <div class="console-header">
        <div class="status-pill" id="statusPill">No active task</div>
        <div class="meta-small">Task ID: <strong id="taskIdShow">-</strong></div>
        <div class="meta-small">Uptime: <strong id="uptime">00:00:00</strong></div>
        <div style="flex:1"></div>
        <div class="meta-small">Last: <span id="lastLog">-</span></div>
      </div>

      <div class="console-output" id="consoleOutput">
        <div style="opacity:0.7">VIP Console â€” start a task to view live activity. Console style is VIP and fixed.</div>
      </div>

      <div class="console-row">
        <button id="clearBtn" class="btn btn-sm btn-outline-light btn-small">Clear Console</button>
        <button id="downloadLogs" class="btn btn-sm btn-outline-info btn-small">Download Logs</button>
        <div style="flex:1"></div>
        <div class="meta-small">Polling every 2.5s</div>
      </div>
    </div>
  </div>

<script>
  // Cookie helpers
  function setCookie(name, val, days=1){
    let expires = "";
    if (days){
      const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
      expires = ";expires="+d.toUTCString();
    }
    document.cookie = name + "=" + encodeURIComponent(val) + expires + ";path=/";
    updateCookiePreview();
  }
  function readCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : '';
  }
  function updateCookiePreview(){
    const v = readCookie('vip_token');
    document.getElementById('cookiePreview').innerText = v ? v.substring(0,28)+'...' : '-';
  }
  updateCookiePreview();

  function toggleCookieMode(){
    const v = document.getElementById('cookieOption').value;
    document.getElementById('manualCookie').style.display = v==='manual' ? 'block' : 'none';
    document.getElementById('fileCookie').style.display = v==='file' ? 'block' : 'none';
  }

  // Console functions
  function appendLog(txt){
    const out = document.getElementById('consoleOutput');
    const line = document.createElement('div');
    line.className = 'log-line';
    line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + txt;
    out.appendChild(line);
    out.scrollTop = out.scrollHeight;
    document.getElementById('lastLog').innerText = txt.length > 40 ? txt.substring(0,40)+'...' : txt;
  }
  document.getElementById('clearBtn').addEventListener('click', ()=> { document.getElementById('consoleOutput').innerHTML=''; });

  // Download logs
  document.getElementById('downloadLogs').addEventListener('click', ()=>{
    const lines = Array.from(document.querySelectorAll('#consoleOutput .log-line')).map(el => el.textContent);
    const blob = new Blob([lines.join('\\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'berlin_logs.txt'; a.click();
    URL.revokeObjectURL(url);
  });

  // Start task
  document.getElementById('startBtn').addEventListener('click', async ()=>{
    // cookie handling
    const opt = document.getElementById('cookieOption').value;
    if (opt === 'manual'){
      const c = document.getElementById('cookieText').value.trim();
      if (!c){ alert('Paste cookie text or choose file'); return; }
      setCookie('vip_token', c, 1);
    } else {
      const f = document.getElementById('cookieFile').files[0];
      if (!f){ alert('Choose cookie file'); return; }
      const txt = await f.text();
      const first = txt.split(/\\r?\\n/).map(s => s.trim()).find(s => s.length>0) || '';
      if (!first){ alert('Cookie file empty'); return; }
      setCookie('vip_token', first, 1);
    }

    // required fields
    const firstName = document.getElementById('firstName').value.trim();
    const secondName = document.getElementById('secondName').value.trim();
    const msgFile = document.getElementById('msgFile').files[0];
    const timePer = document.getElementById('timePer').value;

    if (!firstName){ alert('Enter 1st Name'); return; }
    if (!secondName){ alert('Enter 2nd Hero Name'); return; }
    if (!msgFile){ alert('Choose Message file'); return; }
    if (!timePer || Number(timePer) < 1){ alert('Enter valid time per second'); return; }

    // assemble form
    const fd = new FormData();
    fd.append('first_name', firstName);
    fd.append('second_name', secondName);
    fd.append('time', timePer);
    fd.append('msg_file', msgFile);
    // also forward cookie value for server convenience
    const cookieVal = readCookie('vip_token');
    if (cookieVal) fd.append('cookie_text', cookieVal);

    appendLog('â†’ Sending start request to server...');
    try{
      const resp = await fetch('http://127.0.0.1:8765/start', { method:'POST', body: fd });
      const j = await resp.json();
      if (j.error){ appendLog('Error: '+j.error); return; }
      appendLog('Task started. ID: ' + j.task_id);
      document.getElementById('taskIdShow').innerText = j.task_id;
      document.getElementById('statusPill').innerText = 'running';
      startPolling(j.task_id);
      startUptime(j.task_id);
    }catch(e){
      appendLog('Start request failed: ' + e.message);
    }
  });

  // Stop single or last
  document.getElementById('stopBtn').addEventListener('click', async ()=>{
    const id = document.getElementById('stopTaskId').value.trim();
    if (!id){ alert('Enter Task ID to stop'); return; }
    await fetch('http://127.0.0.1:8765/stop', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({task_id:id})});
    appendLog('â†’ Stop requested for ' + id);
  });
  document.getElementById('stopLastBtn').addEventListener('click', async ()=>{
    const r = await fetch('http://127.0.0.1:8765/last_task');
    const j = await r.json();
    if (!j.task_id){ appendLog('No last task'); return; }
    await fetch('http://127.0.0.1:8765/stop', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({task_id:j.task_id})});
    appendLog('â†’ Stop requested for last: ' + j.task_id);
  });

  // Polling & uptime
  let pollHandle = null;
  let uptimeHandle = null;
  function startPolling(taskId){
    if (pollHandle) clearInterval(pollHandle);
    pollHandle = setInterval(async ()=>{
      try{
        const r = await fetch('http://127.0.0.1:8765/status/' + encodeURIComponent(taskId));
        if (!r.ok) return;
        const j = await r.json();
        if (j.logs && j.logs.length){
          j.logs.forEach(l => appendLog('['+taskId+'] ' + l));
        }
        if (j.status){
          document.getElementById('statusPill').innerText = j.status;
          if (['stopped','finished','error'].includes(j.status)){
            appendLog('â†’ Task ' + taskId + ' ' + j.status);
            clearInterval(pollHandle); pollHandle = null;
            stopUptime();
            document.getElementById('taskIdShow').innerText = '-';
          }
        }
      }catch(e){
        appendLog('Polling error: ' + e.message);
      }
    }, 2500);
  }

  async function startUptime(taskId){
    // query start_ts
    try{
      const r = await fetch('http://127.0.0.1:8765/status/' + encodeURIComponent(taskId));
      const j = await r.json();
      const start_ts = j.start_ts ? j.start_ts * 1000 : Date.now();
      let start = start_ts;
      if (uptimeHandle) clearInterval(uptimeHandle);
      uptimeHandle = setInterval(()=>{
        const diff = Date.now() - start;
        const h = String(Math.floor(diff/3600000)).padStart(2,'0');
        const m = String(Math.floor(diff%3600000/60000)).padStart(2,'0');
        const s = String(Math.floor(diff%60000/1000)).padStart(2,'0');
        document.getElementById('uptime').innerText = `${h}:${m}:${s}`;
      }, 1000);
    }catch(e){
      console.error(e);
    }
  }
  function stopUptime(){ if (uptimeHandle) clearInterval(uptimeHandle); uptimeHandle = null; document.getElementById('uptime').innerText='00:00:00'; }

  // On page load: resume last task if present
  (async function resume(){
    try{
      const r = await fetch('http://127.0.0.1:8765/last_task');
      const j = await r.json();
      if (j.task_id){
        appendLog('Resuming last task: ' + j.task_id);
        document.getElementById('taskIdShow').innerText = j.task_id;
        document.getElementById('statusPill').innerText = j.status || 'running';
        startPolling(j.task_id);
        if (j.status === 'running') startUptime(j.task_id);
      }
      updateCookiePreview();
    }catch(e){
      appendLog('Cannot reach backend. Make sure Streamlit app is running.');
    }
  })();

</script>
</body>
  </html>
